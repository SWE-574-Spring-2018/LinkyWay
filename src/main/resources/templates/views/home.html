<!DOCTYPE html>
<div xmlns:th="http://www.thymeleaf.org" th:fragment="home">
    <style>
        .node {
        }

        .link {
            stroke: #999;
            stroke-opacity: 1;
            stroke-width: 2px;
        }
    </style>

    <div id="d_alert_content" class="row alert alert-info" role="alert">
        <!--/*@thymesVar id="twitterProfile" type="org.springframework.social.twitter.api.TwitterProfile"*/-->
        <span th:text="'Hello, ' + ${twitterProfile.screenName} + ' !'"></span>
        <button id="b_create_node" class="btn btn-primary btn-s" type="button">Create a Node</button>
        <div id="d_create_node">
            <br>
            <input type="text" class="form-control" placeholder="Enter node name...">
        </div>
    </div>

    <div id="d_node_action" class="row alert alert-info">
        <span id="s_node_name"></span>
        <div class="row">
            <br>

            <div class="col-lg-6">
                <div class="input-group">
                    <input type="text" class="form-control" placeholder="Enter tweet url...">
                    <span class="input-group-btn">
                        <button id="b_connect_tweet" class="btn btn-default" type="button">Connect a tweet!</button>
                    </span>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="input-group">
                    <select class="form-control">
                        <option th:each="node : ${nodes}" th:value="${node.id}" th:text="${node.name}"></option>
                    </select>
                    <span class="input-group-btn">
                        <button id="b_connect_node" class="btn btn-default" type="button">Connect to the node!</button>
                    </span>
                </div>
            </div>
        </div>
    </div>

    <svg class="center-block" width="1024" height="400"></svg>

    <script src="http://d3js.org/d3.v4.min.js" type="text/javascript"></script>
    <script src="http://d3js.org/d3-selection-multi.v1.js"></script>
    <script type="text/javascript">
        var svg = d3.select("svg"),
            width = +svg.attr("width"),
            height = +svg.attr("height"),
            node,
            link;

        svg.append('defs').append('marker')
            .attrs({
                'id': 'arrowhead',
                'viewBox': '-0 -5 10 10',
                'refX': 30,
                'refY': 0,
                'orient': 'auto',
                'markerWidth': 5,
                'markerHeight': 5,
                'xoverflow': 'visible'
            })
            .append('svg:path')
            .attr('d', 'M 0,-5 L 10 ,0 L 0,5')
            .attr('fill', '#999')
            .style('stroke', 'none');

        var simulation = d3.forceSimulation()
            .force("link", d3.forceLink().id(function (d) {
                return d.id;
            }).distance(250).strength(1))
            .force("charge", d3.forceManyBody())
            .force("center", d3.forceCenter(width / 2, height / 2));

        d3.json("../js/test.json", function (error, graph) {
            if (error) throw error;
            update(graph.links, graph.nodes);
        })

        function update(links, nodes) {
            link = svg.selectAll(".link")
                .data(links)
                .enter()
                .append("line")
                .attr("class", "link")
                .attr('marker-end', 'url(#arrowhead)')

            link.append("title")
                .text(function (d) {
                    return d.type;
                });

            edgepaths = svg.selectAll(".edgepath")
                .data(links)
                .enter()
                .append('path')
                .attrs({
                    'class': 'edgepath',
                    'fill-opacity': 0,
                    'stroke-opacity': 0,
                    'id': function (d, i) {
                        return 'edgepath' + i
                    }
                })
                .style("pointer-events", "none");

            edgelabels = svg.selectAll(".edgelabel")
                .data(links)
                .enter()
                .append('text')
                .style("pointer-events", "none")
                .style("font-size", "15px")
                .style("font-family", "SaturaTextPro")
                .style("font-size", "15px")
                .style("paint-order", "stroke")
                .style("stroke", "#fff")
                .style("stroke-width", "2px")
                .style("stroke-linecap", "butt")
                .style("stroke-linejoin", "miter")
                .attr("dy", 15)
                .attrs({
                    'class': 'edgelabel',
                    'id': function (d, i) {
                        return 'edgelabel' + i
                    },
                    'fill': '#030303'
                });

            edgelabels.append('textPath')
                .attr('xlink:href', function (d, i) {
                    return '#edgepath' + i
                })
                .style("text-anchor", "middle")
                .style("pointer-events", "none")
                .attr("startOffset", "50%")
                .text(function (d) {
                    return d.type
                });

            node = svg.selectAll(".node")
                .data(nodes)
                .enter()
                .append("g")
                .attr("class", "node")
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended)
                );

            node.append("circle")
                .on("click", function (d) {
                    d3.selectAll("circle")
                        .attr("selected", "false")
                        .style("fill", "#000a2a");
                    d3.select(this)
                        .attr("selected", "true")
                        .style("fill", "#FFF");
                    selected(d);
                })
                .on("mouseover", function () {
                    if (d3.select(this).attr("selected") !== "true")
                        d3.select(this).style("fill", "#FFF");
                })
                .on("mouseout", function () {
                    if (d3.select(this).attr("selected") !== "true")
                        d3.select(this).style("fill", "#000a2a");
                })
                .attr("selected", "false")
                .attr("r", function (d, i) {
                    if (i === 0)
                        return 25;
                    else
                        return 20;
                })
                .style("stroke-width", "2px")
                .style("stroke", "#000a2a")
                .style("fill", "#000a2a")
                .style("cursor", "pointer")

            node.append("title")
                .style("cursor", "pointer")
                .text(function (d) {
                    return d.id;
                });

            node.append("text")
                .attr("dy", -3)
                .attr('dx', 30)
                .style("font-size", "20px")
                .style("paint-order", "stroke")
                .style("stroke", "#fff")
                .style("stroke-width", "1px")
                .style("stroke-linecap", "butt")
                .style("stroke-linejoin", "miter")
                .style("font-family", "SaturaTextPro")
                .style("cursor", "pointer")
                .text(function (d) {
                    return d.name;
                });

            node.append('text')
                .attr('x', 0)
                .attr('dx', 30)
                .attr('dy', 15)
                .style("font-size", "15px")
                .style("paint-order", "stroke")
                .style("stroke", "#fff")
                .style("stroke-width", "1px")
                .style("stroke-linecap", "butt")
                .style("stroke-linejoin", "miter")
                .style("font-family", "SaturaTextPro")
                .style("cursor", "pointer")
                .text(function (d) {
                    return d.type;
                })

            node.append('text')
                .attr('x', 0)
                .attr('dx', -4)
                .attr('dy', 4)
                .style("font-size", "15px")
                .style("font-family", "SaturaTextPro")
                .style("pointer-events", "none")
                .text(function (d) {
                    return d.id;
                })

            simulation
                .nodes(nodes)
                .on("tick", ticked);

            simulation.force("link")
                .links(links);
        }

        function clicked() {
            alert(node.toString());
        }

        function ticked() {
            link
                .attr("x1", function (d) {
                    return d.source.x;
                })
                .attr("y1", function (d) {
                    return d.source.y;
                })
                .attr("x2", function (d) {
                    return d.target.x;
                })
                .attr("y2", function (d) {
                    return d.target.y;
                });

            node
                .attr("transform", function (d) {
                    return "translate(" + d.x + ", " + d.y + ")";
                });

            edgepaths.attr('d', function (d) {
                return 'M ' + d.source.x + ' ' + d.source.y + ' L ' + d.target.x + ' ' + d.target.y;
            });

            edgelabels.attr('transform', function (d) {
                if (d.target.x < d.source.x) {
                    var bbox = this.getBBox();

                    rx = bbox.x + bbox.width / 2;
                    ry = bbox.y + bbox.height / 2;
                    return 'rotate(180 ' + rx + ' ' + ry + ')';
                }
                else {
                    return 'rotate(0)';
                }
            });
        }

        function dragstarted(d) {
            if (!d3.event.active) simulation.alphaTarget(0.3).restart()
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(d) {
            d.fx = d3.event.x;
            d.fy = d3.event.y;
        }

        function dragended(d) {
            return; //it arranges the nodes after drag ended, not needed for the moment

            if (!d3.event.active) simulation.alphaTarget(0);
            d.fx = undefined;
            d.fy = undefined;
        }

        function selected(d) {
            $("#d_node_action").show("slow");
            $("#s_node_name").html(d.name);
            $("#b_connect_tweet").click({d: d}, function () {
                alert(d.name);
            });
        }

        $("#d_node_action").hide();

        $("#b_create_node").click(function () {
            $("#d_create_node").show("slow");
        });
        $("#d_create_node").hide();
    </script>
</div>